---
title: "ANNI_0 erstellen"
author: "Samantha Rubo"
date: '2021-12-15'
output:
  pdf_document: default
---
```{r}
rm(list = ls())
#Daten der erstellen Modelle (Ergebnis von unten)
load("../data/derived_data/Model1/RData_ANNI20220511.RData") 
```
\
### Bibliotheken laden
```{r message=FALSE, warning=FALSE, include=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(purrr)
library(lubridate)
#library(tidyr)
library(neuralnet)
```
\
### Input-Tabelle laden (aus A3_Tabelle_erstellen.RMD)
```{r}
input_tabelle <- data.table::fread(
    "../data/derived_data/input_tabelle_2020_2021_20220504.csv", 
    sep = ";", dec = ".") %>% as_tibble()
```
\
### nFK vom Vortag als Input ausweisen:
```{r}
input_tabelle <- 
    input_tabelle %>%
    ## nFK vom Vortag: 
    # mutate(T0020_nFK_Vortag = c(NA,T0020_nFK[1:(n()-1)]),
    #        T2040_nFK_Vortag = c(NA,T2040_nFK[1:(n()-1)]),
    #        T4060_nFK_Vortag = c(NA,T4060_nFK[1:(n()-1)])) #%>%
    ## mm vom Vortag:
    mutate(T0020_mm_Vortag = c(NA,T0020_mm[1:(n()-1)]),
           T2040_mm_Vortag = c(NA,T2040_mm[1:(n()-1)]),
           T4060_mm_Vortag = c(NA,T4060_mm[1:(n()-1)])) %>%
    mutate(T0020_Auswaschung_mm_Vortag = c(NA,T0020_Auswaschung_mm[1:(n()-1)]),
           T2040_Auswaschung_mm_Vortag = c(NA,T2040_Auswaschung_mm[1:(n()-1)]),
           T4060_Auswaschung_mm_Vortag = c(NA,T4060_Auswaschung_mm[1:(n()-1)])) %>% 
    mutate_at(c("freier_Speicher_T0020_mm", "freier_Speicher_T2040_mm", 
                "freier_Speicher_T4060_mm"), ~ifelse(.<0,0,.)) %>%
    mutate(freier_Speicher_T0020_mm_Vortag = c(NA,freier_Speicher_T0020_mm[1:(n()-1)]),
           freier_Speicher_T2040_mm_Vortag = c(NA,freier_Speicher_T2040_mm[1:(n()-1)]),
           freier_Speicher_T4060_mm_Vortag = c(NA,freier_Speicher_T4060_mm[1:(n()-1)])) 

# slice(-1) #erste Zeile entfernt, da hier NA
```
\
### Wassereintrag aus P + Bewässerung berechnen. Benötigte Variablen selektieren.
```{r}
target <- c("tage_seit_aussaat", 
            "bewaesserung_mm", "Tempsum", "Tmax_gradC", "Tmin_gradC", "Tmean_gradC", 
            "relLuftfeuchte_mean_prozent", "relLuftfeuchte_min_prozent", 
            "Gobsum", "globalstrahlung_Mj_m2", "niederschlag_mm", 
            "windgeschwindigkeit_m_s", "FAO56_mm", 
            "T0020_mm", "T2040_mm", "T4060_mm", 
            #            "T0020_Auswaschung_mm_Vortag", "T2040_Auswaschung_mm_Vortag", "T4060_Auswaschung_mm_Vortag",   
            #            "freier_Speicher_T0020_mm_Vortag", "freier_Speicher_T2040_mm_Vortag", "freier_Speicher_T4060_mm_Vortag",
            #"T0060_mm",
            #"T0020_nFK_Vortag", "T2040_nFK_Vortag", "T4060_nFK_Vortag",
            "T0020_mm_Vortag", "T2040_mm_Vortag", "T4060_mm_Vortag"
)

input_df <- input_tabelle %>% #[1:100,] %>%
    select(satz_id, variante_H2O,wiederholung, target) %>%
    rowwise() %>%
    mutate(wasser_input = sum(niederschlag_mm, bewaesserung_mm, na.rm = TRUE)) %>%
    ungroup %>%
    mutate(wasser_input_Vortag = c(NA,wasser_input[1:(n()-1)])) %>%
    select(-niederschlag_mm, -bewaesserung_mm, -wasser_input) %>%
    tidyr::drop_na()

idx_saetze <- input_df %>% select(satz_id, variante_H2O)
input_df <- input_df %>% select(-satz_id, -variante_H2O)

```
\
### Datensatz skalieren --> notwendig als Input für ANN
```{r}
# The predictor vars must be scaled data for the ANN fitting
df_tmp <-  input_df %>% select(-wiederholung)
input_df.scaled <- data.table::as.data.table(scale(df_tmp))
rm(df_tmp)
# # response var must be scaled to [0 < resp < 1]
input_df.scaled$T0020_mm <- input_df$T0020_mm
input_df.scaled$T2040_mm <- input_df$T2040_mm
input_df.scaled$T4060_mm <- input_df$T4060_mm

input_df.scaled <- input_df.scaled %>%
    mutate_at(c("T0020_mm", "T2040_mm", "T4060_mm"),
              ~scale(., center = min(., na.rm = TRUE),
                     scale = max(., na.rm = TRUE) - min(., na.rm = TRUE)))

```
\
### Index für Trainings- und Test-Datensatz
```{r}
# Train-test split
set.seed(123)
idx <- sample(1:nrow(input_df.scaled), size = tail(nrow(input_df.scaled)*0.7) )
train <- input_df.scaled[idx,]
test <- input_df.scaled[-idx,]
```
\
### ANNI erstellen
## 1. Modell für 0-20cm Tiefe
```{r}
set.seed(1234)
nn0020=map(1:20, 
           ~neuralnet(T0020_mm ~ 
                          tage_seit_aussaat+ 
                          #  Tempsum+
                          Tmax_gradC+
                          #  Tmin_gradC+
                          ##  Tmean_gradC+
                          wasser_input_Vortag+
                          T0020_mm_Vortag+
                          # T2040_mm_Vortag+
                          # T4060_mm_Vortag+
                          ##  relLuftfeuchte_mean_prozent+
                          relLuftfeuchte_min_prozent+
                          Gobsum +
                          #  globalstrahlung_Mj_m2 +
                          windgeschwindigkeit_m_s,
                      
                      data = train, hidden=10, act.fct = "logistic", rep = 1,
                      linear.output = F, algorithm = "rprop+", #"rprop+",#"backprop"
                      learningrate = 0.01, threshold=0.01, stepmax = 1e+6)
)
```

## gesamtes Modell für alle Schichten:
```{r}
# set.seed(1234)
# nn=neuralnet(T0020_mm + T2040_mm ~ 
#                  tage_seit_aussaat+ 
#                  Tempsum+
#                  Tmax_gradC+
#                  Tmin_gradC+
#                  Tmean_gradC+
#                  wasser_input_Vortag+
#                  T0020_mm_Vortag+
#                  T2040_mm_Vortag+
#                  T4060_mm_Vortag+
#                  #  relLuftfeuchte_mean_prozent+
#                  relLuftfeuchte_min_prozent+
#                  Gobsum +
#                  # globalstrahlung_Mj_m2 +
#                  windgeschwindigkeit_m_s,
#              
#              data = train, hidden=10, act.fct = "logistic", rep = 1,
#              linear.output = F, algorithm = "backprop", 
#              learningrate = 0.01, threshold=0.01, stepmax = 1e+6)
```

## 2. Modell für 20-40cm Tiefe
```{r}
set.seed(1234)

nn2040=map(1:20, 
           ~neuralnet(T2040_mm ~ 
                          tage_seit_aussaat+ 
                          Tempsum+ ###
                          ## Tmax_gradC+
                          ## Tmin_gradC+ ##
                          Tmean_gradC+ ##
                          wasser_input_Vortag+ ###
                          T0020_mm_Vortag+
                          T2040_mm_Vortag,
                      #  T4060_mm_Vortag+ #
                      #  relLuftfeuchte_mean_prozent+ #
                      #  relLuftfeuchte_min_prozent+ #
                      #  Gobsum + #
                      #  globalstrahlung_Mj_m2 + #
                      #  windgeschwindigkeit_m_s, #
                      
                      data = train, hidden=10, act.fct = "logistic", rep = 1,
                      linear.output = F, algorithm = "rprop+", #backprop
                      learningrate = 0.01, threshold=0.01, stepmax = 1e+6)
)
```

## 3. Modell für 40cm - 60 Tiefe
```{r}
set.seed(1234)

nn4060=map(1:20, 
           ~neuralnet(T4060_mm ~ 
                          #        T4060_Auswaschung_mm_Vortag + ##Auswaschung eingefügt!!
                          #        T2040_Auswaschung_mm_Vortag + ##Auswaschung eingefügt!!
                          #        freier_Speicher_T2040_mm_Vortag + 
                          tage_seit_aussaat+ 
                          Tempsum+ 
                          Tmax_gradC+
                          #        Tmin_gradC+ 
                          #        Tmean_gradC+ 
                          #        wasser_input_Vortag+ 
                          #        T0020_mm_Vortag+
                          T2040_mm_Vortag+
                          T4060_mm_Vortag+ 
                          #       relLuftfeuchte_mean_prozent+ 
                          #relLuftfeuchte_min_prozent+ 
                          Gobsum,
                      #       globalstrahlung_Mj_m2 + 
                      #       windgeschwindigkeit_m_s, 
                      
                      data = train, hidden=c(10,5), act.fct = "logistic", rep = 1,
                      linear.output = F, algorithm = "rprop+", #backprop
                      learningrate = 0.01, threshold=0.01, stepmax = 1e+6)
)
```
#Chose best repetition
```{r}
# #nn_list <- nn0020 
# #nn_list <- nn2040
# nn_list <- nn4060
# errors1 <- map_dbl(nn_list, ~.x$result.matrix[1,])
# best_rep <-  which.min(errors1 )
# cat("Best Repetition ist: #", best_rep)
# nn <- nn_list[[best_rep]]

nn0020_best <- nn_list_extract(nn_list = nn0020, target_y = "T0020_mm")
nn2040_best <- nn_list_extract(nn_list = nn2040, target_y = "T2040_mm")
nn4060_best <- nn_list_extract(nn_list = nn4060, target_y = "T4060_mm")

```

\
### Nodes plotten
```{r}
#for(i in c(nn0020_best,nn2040_best,nn4060_best)){
plot(nn4060_best[["nn"]],col.hidden = 'darkgreen', 
     col.hidden.synapse = 'darkgreen',
     show.weights = F,
     information = T,
     fill = 'lightblue', 
     #dimension = c(15,13),
     fontsize = 10,
     information.pos = 100
)
#     }
```
```{r}
for(i in 1:3){
    par(mar = c(0,0,0,0) )
    NeuralNetTools::plotnet(mod_in = list(nn0020_best, nn2040_best, nn4060_best)[[i]][["nn"]], 
                            max_sp = TRUE, pad_x = 0.6, cex_val = 0.8)
}
```

#obsolet: Olden variance pro repetition berechnen:
```{r}
#importance of variable per repetiton
olden_per_rep <- function(i, nn_list){
    new_name <- paste0("importance_",i)
    olden1 <- NeuralNetTools::olden(nn_list[[i]], bar_plot = FALSE) %>%
        rename(!!sym(new_name) := importance)
    olden1
}

olden_90_percentile <- function(all_olden_df){
    tt <- t(all_olden_df) %>% as_data_frame() 
    quantiles_olden <- map_df(tt, ~quantile(., probs = c(0.05,0.95)), .id="parameter") %>%
        set_names("parameter","lower", "upper")
    quantiles_olden
}


importance_0020 <- map(1:20, ~olden_per_rep(i = .x, nn_list = nn0020)) %>% bind_cols()
importance_2040 <- map(1:20, ~olden_per_rep(i = .x, nn_list = nn2040)) %>% bind_cols()
importance_4060 <- map(1:20, ~olden_per_rep(i = .x, nn_list = nn4060)) %>% bind_cols()


olden_90_0020 <-  olden_90_percentile(all_olden_df = importance_0020)
olden_90_2040 <-  olden_90_percentile(all_olden_df = importance_2040)
olden_90_4060 <-  olden_90_percentile(all_olden_df = importance_4060)

```


\
```{r}
labels1 <- c("Gobsum" = "Cum. \nirradiance",
             "relLuftfeuchte_min_prozent" = "Rel. \nhumidity",
             "T0020_mm_Vortag" = "SM 0-20cm \n(d-1)",
             "T2040_mm_Vortag" = "SM 20-40cm \n(d-1)",
             "T4060_mm_Vortag" = "SM 40-60cm \n(d-1)",
             "Tempsum" = "Cum. \ntemp",
             "tage_seit_aussaat" = "DAS",
             "Tmax_gradC" = "Temp \nmax",
             "Tmean_gradC" = "Temp \nmean",
             "wasser_input_Vortag" = "Water \nsupply",
             "windgeschwindigkeit_m_s" = "Wind \nspeed"
)
```


#Olden Plots:
```{r}

plots_olden <- map(list(nn0020_best=nn0020_best, nn2040_best=nn2040_best, nn4060_best=nn4060_best),
                   ~NeuralNetTools::olden(.x[["nn"]]) +
                       theme(#axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
                           panel.grid = element_blank( )) +
                       scale_x_discrete("",
                                        #breaks = auswahl$parameter, 
                                        labels = labels1)
)
plots_olden

# Add: 90%-Range for olden for 20 repitions: 
# map(seq_along(plots_olden), ~plots_olden[[.x]] +
#         geom_errorbar(data = list(olden_90_0020,olden_90_2040,olden_90_4060)[[.x]], 
#                       aes(x = parameter, 
#                           ymin = lower, 
#                           ymax = upper), width = 0.2, col = "black"))
```

```{r}
p_olden_combined <- ggpubr::ggarrange(plotlist = plots_olden, ncol = 1, 
                                      align = "hv", labels = "auto")
ggsave(plot = p_olden_combined, filename = "../graphics/Olden_combined.png", 
       device = "png", width = 8*0.8, height = 10*0.8, dpi = 300)
```

![Olden](../graphics/Olden_combined.png)

#Olden einzeln erstellen:
```{r, eval=FALSE}
#p1 <- NeuralNetTools::garson(nn) 
p2 <- NeuralNetTools::olden(nn)
## Beu Multi-Outpu-Data:
#p2 <- NeuralNetTools::olden(nn, "T2040_mm")
# NeuralNetTools::olden(nn, bar_plot = FALSE) #for values
#p1.2 <- p1 + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
p2.2 <- p2 + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
p2.2
```
NeuralNetTools::olden(nn) zeigt auch Vorzeichen: Einige Parameter sind kontraproduktiv für das Neuronale Netzwerk. Sie wurden daher in einem weiteren Schritt entfernt.
https://www.jstatsoft.org/article/view/v085i11




```{r}
plot_measured_predicted <- function(data){
    p1 <- ggplot(data, aes(actual_value, predicted_value,
                           color=as.factor(satz_id))) + 
        geom_point() + 
        geom_abline(slope = 1, intercept = 0, color = "red")+
        #ylab("ANN predicted AWC (%)") + xlab("actual AWC (%)") + 
        ylab("ANN predicted soil water content (mm)") + 
        xlab("Measured soil water content (mm)") + 
        # facet_grid(.~input) + 
        theme_bw() + 
        coord_fixed() + 
        theme(panel.grid = element_blank(),
              legend.position = "bottom") +
        scale_color_discrete("Spinat_satz")
    p1
}

map(list(nn0020_best, nn2040_best, nn4060_best),
    ~plot_measured_predicted(data = .x[["df1"]]))
```
#Lm pro Bodentiefe:
```{r}
all_predicted <- map_df(list(S0020_cm = nn0020_best, S2040_cm = nn2040_best, S4060_cm = nn4060_best),
                        ~.x[["df1"]], .id = "BodenTiefe")
p_all <- plot_measured_predicted(data = all_predicted) + aes(col=BodenTiefe, group = BodenTiefe) +
    geom_smooth(method = "lm", col="black") +
    scale_color_discrete("Soil depth:") +
    theme(legend.position = "right")

p_all
```
```{r}
ggsave(plot = p_all, "../graphics/ANNI_actual_predicted_all.png", device = "png",
       width = 5, height = 5, dpi = 300)
```

```{r}
text_r2 <- data.frame(BodenTiefe = c("S0020_cm", "S2040_cm", "S4060_cm"),
                      R2 = c(0.97, 0.97, 0.96),
                      MSE = c(2.87, 1.05,0.34)) %>%
    mutate(R2_label =  paste0("R2 = ", R2),
           MSE_label = paste0("MSE = ", MSE)
    ) 
p_lm_2 <- ggplot(all_predicted, aes(actual_value, predicted_value)) + 
    geom_point() + 
    geom_abline(slope = 1, intercept = 0, color = "grey70")+
    geom_smooth(method = "lm", col="red", linetype = 1) +
    facet_grid(BodenTiefe~.) +     
    ylab("ANN predicted soil water content (mm)") + 
    xlab("Measured soil water content (mm)") + 
   # geom_text(data = text_r2, aes(x=15, y = 40, label = R2_label, parse = TRUE), size = 3, hjust = 0) + 
    ggpubr::stat_regline_equation(label.y = 41, aes(label = ..rr.label..), size = 3) +
    geom_text(data = text_r2, aes(x=15, y = 35.5, label = MSE_label), size = 3, hjust = 0) + 
    theme_bw() + 
    coord_fixed() + 
    theme(panel.grid = element_blank())
p_lm_2
```



#Zeireihe plotten:
```{r}
add_DAS_to_output_df <- function(data){
    data$tage_seit_aussaat <- (input_df %>% pull(tage_seit_aussaat))
    data$wiederholung <- (input_df %>% pull(wiederholung))
    data
}

all_df1 <- map_df(list(S0020_cm = nn0020_best, S2040_cm = nn2040_best, S4060_cm = nn4060_best),
                  ~add_DAS_to_output_df(data = .x[["df1"]]), .id = "BodenTiefe")

#df1_melted...
# input_df[idx,"tage_seit_aussaat"]
# input_df[-idx,"tage_seit_aussaat"]
```


```{r}
# ggplot(nn0020_best$df1 %>% filter(satz_id == 4, variante_H2O == "Wfull_plus", wiederholung == "a"), 
#        aes(tage_seit_aussaat)) + 
#     geom_line(aes(y=actual_value, col = "actual_value")) + 
#     geom_line(aes(y=predicted_value, col = "predicted_value"))

# ggplot(df1 %>% filter(satz_id == 5, variante_H2O == "Wfull", wiederholung == "c"), 
#        aes(tage_seit_aussaat)) + 
#     geom_line(aes(y=actual_value, col = "actual_value")) + 
#     geom_line(aes(y=predicted_value, col = "predicted_value"))
```





```{r}
p_vertical <- ggplot(all_df1 %>% filter(satz_id == 4, 
                                        variante_H2O == "Wfull_plus", 
                                        wiederholung == "a"), 
                     aes(tage_seit_aussaat)) + 
    geom_line(aes(y=actual_value, col = "actual_value")) + 
    geom_line(aes(y=predicted_value, col = "predicted_value")) + 
    geom_point(aes(y=actual_value, col = "actual_value")) + 
    geom_point(aes(y=predicted_value, col = "predicted_value")) + 
    facet_grid(BodenTiefe~.)+# scales = "free_y") +
    scale_y_continuous(breaks = c(25,30,35,40)) + 
    scale_color_manual("", values = c("actual_value" = "black",
                                      "predicted_value" = "red"), 
                       labels = c("actual_value" = "Measured", 
                                  "predicted_value" = "Predicted")) +
    xlab("Days after seeding") + ylab("Soil water content (mm)") + 
    theme_bw()+
    theme(panel.grid = element_blank(), legend.position = "bottom")
p_vertical
```


```{r}
ggsave(plot = p_vertical, "../graphics/ANNI_actual_predicted_vertical.png", device = "png",
       width = 6, height = 5, dpi = 300)
```

```{r}
plot_combined <- ggpubr::ggarrange(plotlist = list(p_vertical,p_lm_2), 
                                   common.legend = TRUE, widths = c(2,1),
                                   legend = "bottom", labels = "auto") +
    theme(plot.background = element_rect(fill = "white", colour = "white"))
plot_combined
```
```{r}
ggsave(plot = plot_combined, "../graphics/ANNI_actual_predicted_plot_combined2.png", 
       device = "png", width = 8, height = 5, dpi = 300)
```































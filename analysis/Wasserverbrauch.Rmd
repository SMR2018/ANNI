---
title: "Wasserverbrauch"
author: "Samantha Rubo"
date: '2021-12-14'
output: html_notebook
---

```{r message=FALSE, warning=FALSE, include=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(lubridate)
#library(ggnewscale)
#library(tidyr)
```
\
### Input-Tabelle laden (aus A3_Tabelle_erstellen.RMD)
```{r}
input_tabelle <- fread("../data/derived_data/input_tabelle_2020_2021_20220502.csv") %>%
    mutate_at("zeit_messung", ~as_date(.)) %>%
    mutate_at(c("T0020_nFK","T2040_nFK","T4060_nFK"), ~ifelse(.<52,NA,.)) 
#kleinere Werte nicht im vorgegeben Bereich des Tensiometers

input_tabelle
```

\
```{r}
wasserverbrauch <- input_tabelle %>%       
    # mutate_at("T0060_mm", 
    #           ~ifelse(is.na(T0020_nFK)|is.na(T2040_nFK)|is.na(T4060_nFK),NA,.)) %>%
    rowwise() %>%
    mutate(wasserinput_mm = sum(niederschlag_mm, bewaesserung_mm, na.rm = TRUE) ,
           #FAO56 ändern: genauer wäre Evapotranspiration bei unbewachsenem Boden
           #Wenn ein Tensio-Wert fehlt, dann NA
           freier_Speicher_T0060_mm = sum(freier_Speicher_T0020_mm,
                                          freier_Speicher_T2040_mm,
                                          freier_Speicher_T4060_mm, na.rm = FALSE)) %>% 
    #    ungroup() %>%
    mutate_at("wasserinput_mm", ~ifelse(.<0,0,.)) %>%
    group_by(satz_id, variante_H2O, wiederholung) %>%
    #Fehlende Werte Approximieren:
    mutate_at(c("freier_Speicher_T0060_mm","T0060_mm"), ~zoo::na.approx(., na.rm = FALSE))%>%
    # mutate(Tempsum2 = cumsum(Tmean_gradC), .before = Tempsum) %>%
    
    
    
    mutate(wasserinput_vortag = c(0, wasserinput_mm[1:(n()-1)])) %>%
    mutate(wasserinput_vortag_cumsum = cumsum(wasserinput_vortag)) %>% ##cumsum
    mutate(T0060_mm_ohne_input = T0060_mm - wasserinput_vortag_cumsum,
           freier_Speicher_T0060_mm_ohne_input = freier_Speicher_T0060_mm + 
               wasserinput_vortag_cumsum) %>%
    
    mutate(wasser_diff = c(0,diff(T0060_mm_ohne_input)),
           T0060_mm_ohne_input_smooth = zoo::rollmean(T0060_mm_ohne_input, 
                                                      k = 5, align = "center", na.pad = TRUE),
           kumulierter_Wasserverbrauch = freier_Speicher_T0060_mm_ohne_input - 
               min(freier_Speicher_T0060_mm_ohne_input, na.rm = TRUE)) %>%
    mutate(kumulierter_Wasserverbrauch_smooth = 
               zoo::rollmean(kumulierter_Wasserverbrauch, 
                             k = 5, align = "center", na.pad = TRUE)) %>%
    mutate_at("kumulierter_Wasserverbrauch_smooth", ~ifelse(is.na(.), kumulierter_Wasserverbrauch,.)) %>%
    mutate_at("kumulierter_Wasserverbrauch_smooth", 
              ~zoo::rollmean(., k = 5, align = "center", na.pad = TRUE)) %>%
    mutate_at("kumulierter_Wasserverbrauch_smooth", ~ifelse(is.na(.), kumulierter_Wasserverbrauch,.)) %>%
    mutate(taeglicher_wasserverbrauch = c(NA, diff(kumulierter_Wasserverbrauch_smooth)))%>%
    ungroup
```
\
### Gesamt-Wasserinput während der beobachteten Kultivierungsperiode:
```{r}
m <- wasserverbrauch %>% 
    group_by(satz_id, variante_H2O, wiederholung) %>%
    summarize(Verbrauch = sum(wasserinput_mm, na.rm = TRUE)) %>%
    group_by(variante_H2O) %>%
    summarize(Verbrauch = mean(Verbrauch, na.rm = TRUE) %>% round(., 2))

cat(paste("Der gesamte Wassereintrag (Niederschlag  + Bewässerung - Verdunstung) beträgt:mm"))
m
```

```{r}
plot_wassergehalt <- function(satz_nr, variante, wdh, x){
    
    data1 <- wasserverbrauch %>% filter(satz_id ==satz_nr, 
                                        variante_H2O == variante, 
                                        wiederholung == wdh)
    mm_max <- max(data1$T0060_mm, na.rm = TRUE)
    breite <- (range(pull(data1,x), na.rm = TRUE) %>% diff)*0.008
    
    p <- ggplot(data1, aes(!!sym(x),T0060_mm)) +
        #Wasser-Input:
        geom_rect(aes(xmin = !!sym(x)  - breite, #Tage_seit_Aussaat oder tempsum
                      xmax = !!sym(x) + breite, #Tage_seit_Aussaat oder tempsum
                      ymin = mm_max, ymax = wasserinput_mm + mm_max,
                      fill = "P+Bewässerung")) +
        geom_point(aes(color="gemessen")) + 
        geom_line(aes(color="gemessen")) + 
        #Wassergehalt abzüglich des Eintrags durch P + Bewässerung
        geom_line(aes(y=T0060_mm_ohne_input, color = "ohne Input")) +
        ylab("Wassergehalt in 0-60cm Bodentiefe (mm)") + #xlab(x) +
        theme_bw() + 
        scale_fill_manual("Wassereintrag", values = c("P+Bewässerung" = "lightblue")) + 
        scale_color_manual("Wassergehalt", 
                           values = c("gemessen" = "black",
                                      "ohne Input"="red" )) + 
        scale_y_continuous(sec.axis = sec_axis(~.-mm_max, breaks = c(0,5,10,15), 
                                               name = "Wassereintrag (mm)"))+
        theme(panel.grid.major.y  = element_blank(), 
              panel.grid.minor.y = element_blank(), 
              axis.title.y.right = element_text(hjust = 0.05, vjust = 1)) 
    p
}
```


```{r}
plot_wassergehalt(x = "tage_seit_aussaat", satz_nr = 5, variante = "Wfull", wdh = "a")
plot_wassergehalt(x = "tage_seit_aussaat", satz_nr = 5, variante = "Wfull_plus", wdh = "b")

#plot_wassergehalt(x = "Tempsum", satz_nr = 5, variante = "Wfull", wdh = "a")
```


### Sigmoide Kurve fitten:
```{r}
#Modell erstellen
fit_tempsum <- nls(kumulierter_Wasserverbrauch ~a/(1 + exp(-b * (tempsum-c))), 
                   start=list(a=50,b=0.01,c=350), data = wasserverbrauch)
fit_tage <- nls(kumulierter_Wasserverbrauch ~a/(1 + exp(-b * (Tage_seit_Aussaat-c))),
                start=list(a=50,b=1,c=35), data = wasserverbrauch)

#Parameter und Güte anzeigen
summary(fit_tempsum)
summary(fit_tage)

#gefittete Werte 
sigmoid_fit_tempsum <- fitted(fit_tempsum) 
#predict(fit_tempsum, newdata = data.frame(tempsum = wasserverbrauch$tempsum))

sigmoid_fit_tage <- fitted(fit_tage) 
#predict(fit_tage, newdata = data.frame(tempsum = wasserverbrauch$Tage_seit_Aussaat))
# 
# sigmoid_fit_tempsum_df <- data.frame(tempsum =  wasserverbrauch$tempsum,
#                              kumulierter_Wasserverbrauch = sigmoid_fit)


#zu Tabelle hinzufügen
wasserverbrauch$kumulierter_Wasserverbrauch_sigmoid_tempsum <- sigmoid_fit_tempsum
wasserverbrauch$kumulierter_Wasserverbrauch_sigmoid_tage <- sigmoid_fit_tage
```

```{r}
wasserverbrauch <- 
    wasserverbrauch %>% 
    group_by(satz_id, variante_H2O, wiederholung) %>%
    # left_join(sigmoid_fit_df %>% 
    #               rename(kumulierter_Wasserverbrauch_sigmoid = kumulierter_Wasserverbrauch), 
    #           by = "tempsum") %>%
    mutate(tempsum_diff = c(0, diff(Tempsum))) %>%
    #    mutate(taeglicher_wasserverbrauch_sigmoid_tempsum = c(0, diff(kumulierter_Wasserverbrauch_sigmoid_tempsum)) / tempsum_diff) %>%
    
    #    mutate(taeglicher_wasserverbrauch_sigmoid = c(NA, diff(kumulierter_Wasserverbrauch_sigmoid_tage))) %>%
    mutate(taeglicher_wasserverbrauch_smooth = 
               zoo::rollmean(taeglicher_wasserverbrauch, k = 5, align = "center", na.pad = TRUE)) %>%
    #mutate_at("taeglicher_wasserverbrauch_smooth", ~ifelse(is.na(.), taeglicher_wasserverbrauch,.)) %>%
    ungroup %>%
    mutate(wasser_sum = cumsum(wasserinput_mm), .before=wasserinput_mm) %>%
    mutate(x_temp_wasser_sum = Tempsum*wasser_sum, .before=wasserinput_mm)

```

##tägliche Differenz für Tempsum-Model berechnen (Hinweis: gleiche x-Intervalle notwendig!)
```{r}
#a <- wasserverbrauch %>%
#     select(tempsum, kumulierter_Wasserverbrauch_sigmoid)
# b <- approx(x = a$tempsum, y = a$kumulierter_Wasserverbrauch_sigmoid, method = "constant", rule = 1,n = nrow(wasserverbrauch))
# b
# plot(b$y)
# mutate(tempsum_diff = c(0, diff(tempsum))) %>%
#     mutate(taeglicher_wasserverbrauch_sigmoid = c(0, diff(kumulierter_Wasserverbrauch_sigmoid)) - tempsum_diff)


```


### Kumulierten Wasserverbrauch und Regressions plotten:
```{r}
plot_wasser_cumsum <- function(x, satz_nr, variante, wdh, log=FALSE){ #fit
    
    data1 <- wasserverbrauch %>% filter(satz_id ==satz_nr, 
                                        variante_H2O == variante,
                                        wiederholung == wdh) 
    ggplot(data = data1, 
           aes(if(log == TRUE){log(!!sym(x))}else{!!sym(x)},
               kumulierter_Wasserverbrauch)) + 
        geom_point(aes(color = "gemessen")) + geom_line(aes(color = "gemessen")) + 
        # geom_line(data = wasserverbrauch,
        #           aes(!!sym(x),!!sym(fit),
        #               color = "sigmoid fit"),size=1) +
        geom_line(aes(y=kumulierter_Wasserverbrauch_smooth, color = "runmean_5"), size=1) +
        ylab("Kumulierter Wasserverbrauch (mm)") +
        theme_bw() + 
        theme(panel.grid = element_blank()) + 
        scale_color_manual(values = c("gemessen"="black", 
                                      "runmean_5"="deeppink"))#, "sigmoid fit" = "deepskyblue"))
}

# plot_wasser_cumsum("tage_seit_Aussaat", fit = "kumulierter_Wasserverbrauch_sigmoid_tage")
# plot_wasser_cumsum("Tempsum", fit = "kumulierter_Wasserverbrauch_sigmoid_tempsum")

```

```{r}
plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull", wdh = "a", log = FALSE)
plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull", wdh = "a", log = TRUE)
plot_wasser_cumsum("x_temp_wasser_sum",  satz_nr = 5, variante = "Wfull", wdh = "a", log = FALSE)
plot_wasser_cumsum("x_temp_wasser_sum",  satz_nr = 5, variante = "Wfull", wdh = "a", log = TRUE)

plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull", wdh = "b")
plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull", wdh = "c")
plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull", wdh = "d")
```


```{r}
plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull_plus", wdh = "a")
plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull_plus", wdh = "b")
plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull_plus", wdh = "c")

plot_wasser_cumsum("tage_seit_aussaat",  satz_nr = 5, variante = "Wfull_plus", wdh = "d")
plot_wasser_cumsum("x_temp_wasser_sum",  satz_nr = 5, variante = "Wfull_plus", wdh = "d")
plot_wasser_cumsum("x_temp_wasser_sum",  satz_nr = 5, variante = "Wfull_plus", wdh = "d", log = TRUE)

```



Mittleren Wasserverbrauch pro Variante berechnen:
```{r}
wasserverbrauch_pro_variante <- wasserverbrauch %>% ungroup() %>% 
    select(-wiederholung) %>%
    group_by(satz_id, variante_H2O, zeit_messung, tage_seit_aussaat)%>%
    summarise_all(mean, na.rm=TRUE) %>%
    mutate(wiederholung = "Varianten-Mittel", .after = variante_H2O)
wasserverbrauch_pro_variante
```


###Täglichen Wasserverbrauch plotten:
```{r}
# wasserverbrauch <- wasserverbrauch %>%
#     mutate_at("taeglicher_wasserverbrauch", ~approx(x = ., rule = 2, n = n())$y) %>%
#     mutate(taeglicher_wasserverbrauch_smooth = 
#                signal::sgolayfilt(taeglicher_wasserverbrauch,p = 3, n = 21))

plot_taeglichen_wasserverbrauch <- function(satz_nr, wdh = "Varianten-Mittel"){
    
    data1 <- if(wdh=="Varianten-Mittel"){wasserverbrauch_pro_variante} else{wasserverbrauch}
    
    data1 <- data1 %>% filter(satz_id ==satz_nr) %>%
        filter(between(taeglicher_wasserverbrauch,0,7))
    
    ratio1 <-  if(wdh=="Varianten-Mittel"){2/3} else{3/4}
    
    ggplot(data = data1, aes(x = tage_seit_aussaat,#x_temp_wasser_sum, #, 
                             y = taeglicher_wasserverbrauch,
                             color="gemessen")) + 
        geom_point() + geom_line() + 
        geom_line(aes(y = taeglicher_wasserverbrauch_smooth, color = "runmean_5"),size=1) + 
        # geom_line(aes(y = taeglicher_wasserverbrauch_sigmoid,#*
        # mean(diff(wasserverbrauch$tempsum), na.rm = TRUE), 
        # color = "sigmoid fit"),size=1) + 
        scale_color_manual("", values = c("gemessen"="black", 
                                          "runmean_5"="deeppink"))+#, 
        #                                      "sigmoid fit" = "deepskyblue")) +
        ylab("Täglicher Wasserverbrauch (mm)") + 
        theme_bw() +
        theme(aspect.ratio=ratio1,
              legend.position = "bottom")+
        facet_grid(variante_H2O~wiederholung)
}
```

```{r}
#```{r, fig.height=5}
plot_taeglichen_wasserverbrauch(satz_nr = 2, wdh = "Varianten-Mittel")
#plot_taeglichen_wasserverbrauch(satz_nr = 2, wdh = "")

plot_taeglichen_wasserverbrauch(satz_nr = 3, wdh = "Varianten-Mittel")
#plot_taeglichen_wasserverbrauch(satz_nr = 3, wdh = "")

plot_taeglichen_wasserverbrauch(satz_nr = 4, wdh = "Varianten-Mittel")
#plot_taeglichen_wasserverbrauch(satz_nr = 4, wdh = "")

plot_taeglichen_wasserverbrauch(satz_nr = 5, wdh = "Varianten-Mittel")
#plot_taeglichen_wasserverbrauch(satz_nr = 5, wdh = "")
```






```{r}
#write.table(wasserverbrauch, "../data/derived_data/wasserverbrauch_2021_Satz1.csv", 
#            sep = ";", row.names = FALSE, dec = ".")
```


#Vergleich GS & Saugspannung
```{r}
ggplot(wasserverbrauch_pro_variante %>% filter(satz_id==5 & variante_H2O == "Wfull"), 
       aes(cumsum(FAO56_mm),kumulierter_Wasserverbrauch)) + 
    geom_smooth() + 
    geom_point() + 
    geom_abline(slope = 1, intercept = 0, aes(color="1:1-Linie")) + 
    coord_fixed() + 
    ylab("kumulierter Wasserverbrauch (mm): \n Saugspannung + P + Bewässerung") + 
    theme_bw() + 
    theme(panel.grid = element_blank())
```

```{r}

```

#To-Do:
- Auswaschungen berücksichtigen: mm über 100%nFK (in 40-60cm?) vom Verbrauch abziehen.
- Verbrauch korrigieren, wenn Tensiometer-Werte für eine oder mehrere Tiefen fehlen. 
--> Am Ende: entfernen.
--> in der Mitte: na.approx? approx? (interpolieren)

Für Bodentiefe 0-20 und 20-40cm: wenn am nächsten Tag nFK in der tieferen Schicht steigt, dann 

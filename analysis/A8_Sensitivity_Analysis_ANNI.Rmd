---
title: "A8_Sensitivity_Analysis_ANNI"
---


```{r, message=FALSE}
library(keras)
library(mlbench)
library(dplyr)
library(neuralnet)
library(ggplot2)
library(NeuralSens) #Sensitivity Analysis
```

#Gespiechertes Modell laden:
```{r, eval=TRUE}
#filepath_tf <- "../data/derived_data/Model5_DWD_pretrained/ANNI_Tensorflow_Schicht2040cm_20230718/"
# filepath_tf <- "../data/derived_data/Model5_DWD_pretrained/ANNI_Tensorflow_Schicht2040cm_mit_Versuchsdaten_20230718/"
#filepath_tf <- "../data/derived_data/Model5_DWD_pretrained/ANNI_Tensorflow_Schicht4060cm_20230718"
#filepath_tf <- "../data/derived_data/Model5_DWD_pretrained/ANNI_Tensorflow_Schicht4060cm_mit_Versuchsdaten_20230718"
#filepath_tf <- "../data/derived_data/Model5_DWD_pretrained/ANNI_Tensorflow_Schicht0020cm_20230718"
filepath_tf <- "../data/derived_data/Model5_DWD_pretrained/ANNI_Tensorflow_Schicht0020cm_mit_Versuchsdaten_20230718"

new_model <- load_model_tf(filepath_tf)
# Check its architecture
summary(new_model)
```



# Sensitivitäts-Analyse:
```{r}
model_weights <- get_weights(new_model)
wts <- c()

neural_struct <- c(nrow(model_weights[[1]]))

for (i in seq(2, length(model_weights), 2)) {
    neural_struct <- c(neural_struct, dim(model_weights[[i]]))
    lyr_wgts <- rbind(model_weights[[i]], model_weights[[i - 1]])
    wts <- c(wts, unname(do.call(c, as.data.frame(lyr_wgts))))
}

neural_struct

#actfunc <-c("sigmoid", "sigmoid", "linear") 
actfunc <-c("sigmoid", "sigmoid", "sigmoid", "linear") 
#c("sigmoid", "sigmoid")
#c("linear", "ReLU", "ReLU", "linear")
```



training,trainingtarget aus A5_ANNI... des zugehörigen Modells
```{r}
daten <- scaled_versuchsdaten1
daten_names <- names(data_versuch1)

# daten <- scaled_dwd1 
# daten_names <- names(data1) 
    
trData1 = as.data.frame(cbind(
    daten$training,daten$trainingtarget))[1:1000,]

coefnames1 = daten_names[-1]

#Fehlermeldung bei zu langen Namen. Daher hier kürzen:
coefnames1 = gsub(x = coefnames1, pattern = "relLuftfeuchte", replacement = "RLF") %>% 
    gsub(x = ., pattern = "prozent", replacement = "%") %>%
    gsub(x = ., pattern = "Vortag", replacement = "d-1")# %>%

output_name1 = daten_names[1]
```


```{r}
sens_keras <- SensAnalysisMLP(
    wts, 
    trData = trData1,
    mlpstr = neural_struct, 
    coefnames = coefnames1,
    output_name = output_name1,
    actfunc = actfunc, plot = FALSE) 
#summary(sens_keras)
```


```{r include=FALSE}
p1 <- plot(sens_keras)
```

```{r, fig.width=10, dpi=300}
p1[[1]]$layers[[5]] <- NULL
p1[[1]] +
    ggrepel::geom_label_repel(aes(label =varNames, x =mean, y =std ), size = 2,
                              box.padding = unit(0.25, "lines")) +
    theme(panel.grid = element_blank())
```


```{r}
p1[[2]] + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5),
                panel.grid = element_blank())
```


```{r, warning=FALSE}
#p1[[3]]$data <- p1[[3]]$data %>% filter(!variable %in% c("C_org_prozent","Sand_prozent","Schluff_prozent", "Ton_prozent", "tageslicht_h_sum", "tage_seit_aussaat", "Tmin_gradC"))

p1[[3]] + theme(legend.position = "none")
legend3 <- ggpubr::get_legend(p1[[3]])
plot(legend3)
```


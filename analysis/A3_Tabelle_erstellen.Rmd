---
title: "3. Tabelle erstellen für einen gewählten Satz Spinat"
author: "Samantha Rubo"
date: '2021-12-10'
---

```{r message=FALSE, warning=FALSE, include=FALSE}
library(data.table)
library(dplyr)
library(ggplot2)
library(lubridate)
library(ggnewscale)
library(tidyr)
library(DBI)
```

#Wetter-Daten aus DB auslesen:
```{r}
path0 <- "GeoSenSys2020/Data_2020/Database_Protokolle/Database_CSV_Tabellen_HGU/HGU_GeoSenSys_V3_6.db"
# Verbindung zur Datenbanl herstellen:
path1 <- ifelse(Sys.info()["user"] == "samantha_machgu",
                "~/Documents/Mac_HGU_Github/", 
                "../../"
)
db <- paste0(path1, path0) # DB in other R-Project

db1 <- dbConnect(RSQLite::SQLite(), db)

query2 <- "SELECT *  FROM Wetter;"
wetter <- dbGetQuery(db1, query2) %>% # Niederschlag aller Saetze einlesen
    mutate_at("datum_wetter", ~data.table::as.IDate(.)) %>% 
    mutate_at("datum_wetter", ~as_date(.)) %>%
    arrange(wetter_id)
dbDisconnect(db1)
rm(query2)
names(wetter)

# als csv speichern:
fwrite(x = wetter, file = "../data/derived_data/wetter_2020_2022_20220805.csv", sep = ";")
```

#Tensio einlesen:
```{r}
tensio <- fread("../data/derived_data/nfK_2020_2022_20220805_10cm_Schritte.csv") %>%
    mutate_at("zeit_messung", ~as_date(.))

```

#bewaesserung einlesen:
```{r}
bewaesserung <- fread("../data/derived_data/bewaesserung_2020_2022_20220805.csv") %>%
    mutate_at("datum_bewaesserung", ~as_date(.)) %>%
    as_tibble()
```

#Alle Tabellen joinen:
```{r}
input_tabelle <- tensio %>% 
    left_join(bewaesserung, by = c("satz_id", "variante_H2O", "wiederholung",
                                   "zeit_messung" = "datum_bewaesserung")) %>%
    left_join(wetter, by = c("satz_id","zeit_messung" = "datum_wetter")) %>%
    mutate_at("bewaesserung_mm", ~ifelse(is.na(.), 0, .))
```


### Wasserhaltevermögen der Felder der HGU:
|Schicht Nr.|Bezeichnung|100%nFK entsprechen|"Wassergehalt (Vol.% bei 100%nFK)"|
|:---------:|:---------:|:-----------------:|:--------------------------------:|
|   1       |	0-30 cm	|       49.3 mm     |	            16.4%              |
|   2       |  30-60 cm |       46.1 mm     |	            15.4%              |
|   3       |  60-90 cm |       43.4 mm     |               14.5%              |


\
#Fehlende Werte approximieren:
```{r}
input_tabelle <- input_tabelle %>%
    group_by(satz_id, variante_H2O, wiederholung) %>%
    #Fehlende Werte Approximieren:
    mutate(across(.cols = contains("nFK"), 
                  ~zoo::na.approx(., na.rm = FALSE)))
```

\
# Wassergehalt in mm (fließt nicht mehr in ANNI ein)
<!-- ### Vol% Wasser bei 100% nFK für drei Bodentiefen (Schichttiefe je 20cm) -->
<!-- ```{r} -->
<!-- B10_mm_bei100nFK <- 49.3/30*10 #Tabellenwert steht für 30cm Schichtdicke. Umrechnen auf 10cm. -->
<!-- B50_mm_bei100nFK <- 46.1/30*10 -->
<!-- B30_mm_bei100nFK <- B10_mm_bei100nFK - (B10_mm_bei100nFK-B50_mm_bei100nFK)/2 -->
<!-- ``` -->
<!-- # Bodenwassergehalt in mm berechnen: -->
<!-- ```{r} -->
<!-- input_tabelle <- input_tabelle %>% -->
<!--     # #Auswaschung berechnen: -->
<!--     # mutate(B10_Auswaschung_prozent_nFK = ifelse(B10_nFK > 100, B10_nFK - 100, 0), -->
<!--     #        B30_Auswaschung_prozent_nFK = ifelse(B30_nFK > 100, B30_nFK - 100, 0), -->
<!--     #        B50_Auswaschung_prozent_nFK = ifelse(B50_nFK > 100, B50_nFK - 100, 0)) %>% -->
<!--     #  -->
<!--     # mutate(B10_Auswaschung_mm = B10_Auswaschung_prozent_nFK * 0.01 * B10_mm_bei100nFK, -->
<!--     #        B30_Auswaschung_mm = B30_Auswaschung_prozent_nFK * 0.01 * B30_mm_bei100nFK, -->
<!--     #        B50_Auswaschung_mm = B50_Auswaschung_prozent_nFK * 0.01 * B50_mm_bei100nFK) %>% -->
<!--     #  -->
<!--     #nFK in mm umrechnen: -->
<!--     mutate(B10_mm = 0.01 * nFK_0010 * B10_mm_bei100nFK, -->
<!--            B20_mm = 0.01 * nFK_1020 * B10_mm_bei100nFK, -->
<!--            B30_mm = 0.01 * nFK_2030 * B30_mm_bei100nFK, -->
<!--            B40_mm = 0.01 * nFK_3040 * B30_mm_bei100nFK, -->
<!--            B50_mm = 0.01 * nFK_4050 * B50_mm_bei100nFK, -->
<!--            B60_mm = 0.01 * nFK_5060 * B50_mm_bei100nFK) %>% -->

<!--     # #"freien Speicher" berechnen: Wieviel mm Wasser kann die Schicht noch aufnehmen? -->
<!--     # mutate(freier_Speicher_B10_mm = B10_mm_bei100nFK - B10_mm, -->
<!--     #        freier_Speicher_B30_mm = B30_mm_bei100nFK - B30_mm, -->
<!--     #        freier_Speicher_B50_mm = B50_mm_bei100nFK - B50_mm) %>%  -->

<!--     rowwise() %>% -->
<!--     mutate(T0060_mm = sum(across(B10_mm:B60_mm), na.rm = FALSE)) %>% -->
<!--     #Wenn ein Tensiometer-Wert einer Schicht fehlt, dann wird T0060_mm auf NA gesetzt. -->
<!--     ungroup() -->

<!-- #filter_at(c("B10_nFK","B30_nFK","B50_nFK"), any_vars(.<52)) -->

<!-- input_tabelle  -->
<!-- ``` -->




## Bodenart anfuegen
```{r}
input_tabelle <- input_tabelle %>% 
    mutate(Ton_prozent = 20,
           Schluff_prozent = 30,
           Sand_prozent = 50,
           C_org_prozent = 1.2)
```

## ISARIA-Daten anfügen
```{r}
db1 <- dbConnect(RSQLite::SQLite(), db)
isaria <- dbGetQuery(db1, "SELECT 
                     Spinat_Saetze.satz_id,
                     ISARIA_N.datum_messung,
                     Varianten.variante_H2O,
                     Parzellen.wiederholung,
                     ISARIA_N.ibi,
                     ISARIA_N.irmi
                     FROM ISARIA_N
                     
                     LEFT JOIN Parzellen ON ISARIA_N.parzelle_id = Parzellen.parzelle_id
                     LEFT JOIN Varianten ON Parzellen.variante_id = Varianten.variante_id
                     LEFT JOIN Spinat_Saetze ON Varianten.satz_id = Spinat_Saetze.satz_id;") %>%
    mutate_at("datum_messung", ~as_date(.))
dbDisconnect(db1)

#Mittelwert pro Parzelle Messzeitpunkt
isaria <- isaria %>% 
    group_by(satz_id, variante_H2O, wiederholung, datum_messung) %>%
    summarise(across(ibi:irmi, ~mean(., na.rm=TRUE)), .groups = "drop") %>%
    mutate_if(is.numeric, ~round(., 2))
```

#Isaria: Interpolation zwischen den Messtagen:
```{r}
input_plus_isaria <- input_tabelle %>% 
    left_join(isaria, by = c("satz_id", "variante_H2O", "wiederholung", "zeit_messung" = "datum_messung")) %>% 
    group_by(satz_id, variante_H2O, wiederholung) %>%
    #Werte vor der ersten ISARIA-Messung werden gelöscht (keine Interpolation möglich)
    mutate(delete_leading_NA = ifelse(is.na(ibi), 0, 1) %>% cumsum(.) %>% cumsum(.)) %>%
    filter(delete_leading_NA > 0) %>%    
    select(-delete_leading_NA) %>%
    filter(satz_id > 2) %>%
    group_by(satz_id, variante_H2O, wiederholung) %>%
    mutate(across(ibi:irmi,~approx(x=., method = "linear", rule = 1, n = n())$y)) %>%
    ungroup

# ggplot(input_plus_isaria, aes(tage_seit_aussaat, ibi, 
#                               col = as.factor(satz_id), linetype = variante_H2O)) +
# stat_summary(fun = "mean", geom = "line")
```
\

### nFK vom Vortag als Input ausweisen:
```{r}
input_tabelle <- 
    input_tabelle  %>%
    mutate(across(c("nFK_0010","nFK_1020","nFK_2030","nFK_3040","nFK_4050","nFK_5060"), 
                  ~c(NA,.[1:(n()-1)]) , 
                  .names = "{.col}_Vortag")
    )
```
\
### Wassereintrag aus P + Bewässerung berechnen. 
```{r}
input_tabelle <- input_tabelle %>% 
    rowwise() %>%
    mutate(wasser_input = sum(niederschlag_mm, bewaesserung_mm, na.rm = TRUE)) %>%
    ungroup %>%
    mutate(wasser_input_Vortag = c(NA,wasser_input[1:(n()-1)]))
```

#Benötigte Variablen selektieren.
```{r}
input_tabelle <- 
    input_tabelle  %>%
    select(-niederschlag_mm, -bewaesserung_mm, -wasser_input,-wiederholung, -satz_id, 
           -variante_H2O, -zeit_messung, -wetter_id) %>%
    select(contains("nFK"), !contains("nFK")) %>%
    tidyr::drop_na()
```

### Tabelle speichern on Projekt-Ordner für Daten
```{r}
# write.table(x = input_tabelle,
#             file = "../data/derived_data/input_tabelle_2020_2022_20220808_complete.csv",
#             sep = ";",dec = ".", row.names = FALSE)
```



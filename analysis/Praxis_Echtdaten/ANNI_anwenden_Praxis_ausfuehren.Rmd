---
title: "Rendern von ANNI-Ergebnissen"
author: "Samantha Rubo"
date: "2023-04-24"
---

## Allgemeine Infos: Pfad zum Modell und Skalierungs-Daten
```{r}
scaling_data_path <-  
      "../../data/derived_data/scaling_data_addedVIs_20230524.csv"
    #"../../data/derived_data/scaling_data_addedVIs.csv" #G1, klappt
    #"../../data/derived_data/Model2/scaling_data.csv" #Goriginal, klappt
#"../../data/derived_data/scaling_data_allDWD_pretrained.csv"
filepath_tf <-  
    "../../data/derived_data/Model3/ANNI_Tensorflow_20230524_neueVIs/"
    # "../../data/derived_data/Model3/ANNI_Tensorflow_20230523_neueVIs/" ##G1, klappt
    #"../../data/derived_data/Model2/ANNI_Tensorflow_20230420" #Goriginal, klappt
#"../../data/derived_data/Model3/ANNI_Tensorflow_20230516_mitDWD/"

auszufuehrendes_RMD <-  paste0(rstudioapi::getActiveProject(),
                               "/analysis/Praxis_Echtdaten/ANNI_anwenden_Praxis_default.Rmd")

render_ANNI <- function(name1, betrieb, feld, satz, filepath_tf, scaling_data_path, 
                        wetter_anbau_daten_csv, datum_aussaat){
    rmarkdown::render(quiet = TRUE, clean = F,
                      input = auszufuehrendes_RMD,  
                      output_file = paste0(name1, ".pdf"), 
                      params = list(
                          betrieb = betrieb,
                          feld = feld,
                          satz= satz,
                          filepath_tf=filepath_tf,
                          scaling_data_path=scaling_data_path,
                          wetter_anbau_daten_csv=wetter_anbau_daten_csv,
                          datum_aussaat = datum_aussaat)
    )
}
```

# Rendern startet hier:

## Voll: Mittelgewann // ABGESCHLOSSEN
```{r}
betrieb = "Voll"
feld <- "Mittelgewann"
satz <- 1
name1 <- paste("Fa", betrieb, "Feld", feld, format.Date(Sys.Date(), "%d_%m_%Y"), sep = "_")
wetter_anbau_daten_csv <-  "../../data/derived_data/Wetterdaten_Praxis/Mittelgewann/daten_komplett.csv"
datum_aussaat <- "2023-03-01"

render_ANNI(name1 = name1, betrieb = betrieb, feld = feld, satz= satz, filepath_tf=filepath_tf,
            scaling_data_path=scaling_data_path, wetter_anbau_daten_csv=wetter_anbau_daten_csv, datum_aussaat = datum_aussaat)
```

## Voll: Stichelpfad 
```{r}
#Ibi und Irmi zu gering am Anfang bei modellierten Werten? Diese bisher nicht im ANNI-Training...
# df1 <- fread(wetter_anbau_daten_csv)
# 
# df2 <- df1 %>% mutate_at("ibi", ~ifelse(.<2.3,2.3,.)) %>%
#     mutate_at("irmi", ~ifelse(.<16,16,.))
# 
# fwrite(df2, "../../data/derived_data/Wetterdaten_Praxis/Stichelpfad/daten_komplett.csv")
```
```{r, eval=FALSE}
betrieb = "Voll"
feld <- "Stichelpfad"
satz <- 1
name1 <- paste("Fa", betrieb, "Feld", feld, format.Date(Sys.Date(), "%d_%m_%Y"), sep = "_")
wetter_anbau_daten_csv <-  paste0("../../data/derived_data/Wetterdaten_Praxis/", feld, "/daten_komplett.csv")
datum_aussaat <- "2023-04-18"

render_ANNI(name1 = name1, betrieb = betrieb, feld = feld, satz= satz, filepath_tf=filepath_tf,
            scaling_data_path=scaling_data_path, wetter_anbau_daten_csv=wetter_anbau_daten_csv, datum_aussaat = datum_aussaat)
```

## Haas: Kämmerwiese
```{r, eval=FALSE}
betrieb = "Haas"
feld <- "Kämmerwiese"
satz <- 1
name1 <- paste("Fa", betrieb, "Feld", feld, format.Date(Sys.Date(), "%d_%m_%Y"), sep = "_")
wetter_anbau_daten_csv <-  paste0("../../data/derived_data/Wetterdaten_Praxis/", feld, "/daten_komplett.csv")
datum_aussaat <- "2023-04-27"

render_ANNI(name1 = name1, betrieb = betrieb, feld = feld, satz= satz, filepath_tf=filepath_tf,
            scaling_data_path=scaling_data_path, wetter_anbau_daten_csv=wetter_anbau_daten_csv, datum_aussaat = datum_aussaat)
```


#Fiktive Niederschlagsdaten für Plausibilitätsanalyse
```{r}
df <- data.table::fread("../../data/derived_data/Wetterdaten_Praxis/Kämmerwiese/daten_komplett.csv")
# df2 <- df %>% mutate_at("ibi", ~ifelse(.<2,2,.)) %>%
#      mutate_at("irmi", ~ifelse(.<16.4,16.4,.))
df2 <- df %>% mutate(across(c("ibi", "irmi"), ~.+1.5)) 
# plot(df$wasser_input_Vortag)
#
# df2 <- df %>% mutate_at("wasser_input_Vortag", ~sample(x = c(0,5,50,100), size = n(), replace = TRUE))
# df2$niederschlag_mm_sum = cumsum(df2$wasser_input_Vortag)
# plot(df2$wasser_input_Vortag)
# plot(df2$niederschlag_mm_sum)
#
#
data.table::fwrite(df2, "../../data/derived_data/Wetterdaten_Praxis/Kämmerwiese/daten_komplett2.csv")
```

# Vergleich mit FAO56 (geschätzt)
```{r include=FALSE}
library(rdwd)
link <- selectDWD("Worms", res="daily", var="kl", per="recent")
file1 <- dataDWD(link, dir=tempdir(), read=TRUE)
clim1 <- file1 %>% select(MESS_DATUM, Niederschlag_mm = RSK)
```

## FAO56 
FAO56 ist bei AMBAV-Modell enthalten:
```{r include=FALSE}
dbase <- "ftp://opendata.dwd.de/climate_environment/CDC/derived_germany"
soilIndex <- indexFTP(folder="soil/daily", base=dbase)
soilIndex <- createIndex(soilIndex, base=dbase)
#  "res" and "var" are inverted in the derived_germany folder!
colnames(soilIndex)[1:2] <- c("var", "res")

## Download:
soil_link <- selectDWD(id = 5692, res="", var="", per="recent",
                       base=dbase, findex=soilIndex)
soil_data <- dataDWD(soil_link, base=dbase, dir = tempdir(), read = TRUE)
```

```{r}
library(data.table)
#,feldinfo, zeitraum, 
anni_out <- fread(paste0("../../data/derived_data/ANNI_Praxis/Haas_Kämmerwiese_Satz_1_DAS1_32.csv"))
wurzel_df <- fread(paste0("../../data/derived_data/Wetterdaten_Praxis/Kämmerwiese/durchwurzelte_schicht.csv"))

anni_out <- anni_out %>% 
    mutate(schicht = substr(depth, 7,8)) %>%
    left_join(wurzel_df, by = "tage_seit_aussaat") %>%
    filter(schicht <= durchwurzelte_schicht_10cm) %>%
    group_by(tage_seit_aussaat) %>%
    summarise(nFK_anni = mean(predicted_nFK), .groups = "drop")
```

```{r}
#Klimatische Wasserbilanz berechnen:
#VPGPM = potentielle Evapotranspiration über Gras nach Penman Monteith (FAO), in mm
#max_mm_in_Schicht <- 90 #mm: 100% nFK bei Schichthöhe von 60cm
#min_mm_in_Schicht <- 10 #mm: 0% nFK bei Schichthöhe von 60cm

df <- 
    soil_data %>% select(Datum, FAO_mm = VPGPM) %>%
    filter(Datum >= "2023-04-18") %>%
    left_join(clim1, by = c("Datum" = "MESS_DATUM")) %>%
    mutate(tage_seit_aussaat = cumsum(c(1, diff(Datum)))) %>%
    mutate(Niederschlag_Vortag = c(NA, Niederschlag_mm[1:(n()-1)])) %>%
    mutate(kc = case_when(tage_seit_aussaat < 20 ~ 0.7,
                          tage_seit_aussaat < 40 ~ 0.9,
                          tage_seit_aussaat >= 40 ~ 1)) %>%
    mutate(KWB = kc * FAO_mm - Niederschlag_Vortag) %>%     ### KWB berechnen
    tidyr::drop_na() %>%
    left_join(wurzel_df, by = "tage_seit_aussaat") %>%
    mutate_at("durchwurzelte_schicht_10cm", ~ifelse(.<30,30,.)) %>%
    mutate(max_mm_in_Schicht = 1.5*durchwurzelte_schicht_10cm,        ## Durchwurzelte Schicht wie ANNI
           min_mm_in_Schicht = (1/6)*durchwurzelte_schicht_10cm) %>%
    mutate(Wasserdefizit = cumsum(KWB)) %>%
    mutate(Wassergehalt_mm = max_mm_in_Schicht - Wasserdefizit) %>% 
    mutate(nFK_geschaetzt = ((Wassergehalt_mm - min_mm_in_Schicht) / (max_mm_in_Schicht - min_mm_in_Schicht)) * 100)  ##nFK berechnen
#df
```

```{r}
ggplot() + 
    geom_line(data = df, aes(tage_seit_aussaat, nFK_geschaetzt, col = "FAO56")) +
    geom_line(data = anni_out, aes(tage_seit_aussaat, nFK_anni, col = "ANNI")) + 
    geom_col(data = df, aes(tage_seit_aussaat, Niederschlag_mm*10), ) + 
    geom_hline(yintercept = 60, color = "grey70") + 
    scale_y_continuous(limits = c(0,200), 
                       sec.axis = sec_axis(name = "Niederschlag (mm)", trans = ~./10)) + 
    theme_bw() + 
    theme(panel.grid = element_blank())
```




---
title: "Stationsdaten DEutschlandweit extrahieren für ANNI"
author: "Samantha Rubo"
date: "2022-10-25"
---

#Pakete laden:
```{r, message=FALSE}
library(data.table)
library(rdwd) ## Paket fuer DWD-Daten-Import!
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)
library(lubridate)
```

# Welche Parameter werden benötigt?
## Header (Parameter) für ANNI:
```{r}
parameter_anni <- fread(
    "../data/derived_data/input_tabelle_2020_2022_20220808_complete.csv", 
    sep = ";", nrows = 1, header = FALSE) %>% t
parameter_anni
```
# Bei DWD sind folgende Stations-Daten verfügbar:
```{r}
# PARAMETER # KUERZEL # ORDNER
# Temperatur --> min, max, mean, threshold, sum # TMK, TXK, TNK # kl
# rel. Luftfeuchte --> min, max, mean,# UPM: nur Tagesmittel# kl, moisture
# Globalstrahlung --> sum1, sum2# # solar
# Windgeschwindigkeit # FM# kl
# Niederschlag# RSK # kl
# Tageslichtstunden (berechnen) --> tag, threshold, sum # --- # ---
```


Die Daten der nFK stammen vom DWD. 
"Da die Messung der Bodenfeuchte sehr aufwendig und fehlerbehaftet ist, wird sie mittlerweile nicht mehr gemessen, sondern berechnet." (https://www.dwd.de/DE/leistungen/bodenfeuchte_dl/bodenfeuchtedl.html, 31.10.22)
Die Bodenfeuchte ist verfügbar in 10-cm-Schritten bis 60 cm Tiefe unter Gras bei lehmigen Sand (leichter Boden) oder sandigem Lehm (schwerer Boden).
(Wie weit zurück reichen die Daten?? Davon hängt ab, bis wann die Stationsdaten der anderen Parameter geladen werden)

# Server ansprechen und Index der Bodenfeuchte-Daten erstellen:
```{r, rows.print = 25}
dbase <- "ftp://opendata.dwd.de/climate_environment/CDC/derived_germany"
soilIndex <- indexFTP(folder="soil/daily", base=dbase, dir=locdir())
soilIndex <- createIndex(soilIndex, base=dbase, dir=locdir())
#"res" and "var" are inverted in the derived_germany folder!
colnames(soilIndex)[1:2] <- c("var", "res")
soilIndex
#soilIndex %>% select(per, id) %>% filter(!is.na(id)) 
```

## "Stations_id" der Stationen mit Bodenfeuchte für "recent" und "historical" auslesen.
```{r}
id_nFK <- soilIndex %>% select(per, id) %>% 
    filter(!is.na(id)) %>%
    group_by(id) %>%
    summarise(nn = n()) %>% 
    filter(nn == 2) %>% pull(id)
```

# Welche Wetter-Daten sind verfügbar an den Stationen?

## Meta-Index des DWD nutzen:
```{r}
meta1 <- rdwd:::metaIndex
str(meta1)
```

## Welche Parameter sind generell verfügbar?
```{r}
meta1$var %>% unique()
# wir brauchen "kl": "Klima". Aber welche Parameter sind an der jeweiligen Station gemessen?
# zusätzlich "solar", da Globalstrahlung nicht in Klima-Daten vorhanden ist.
```

## Auswahl der Stationen in Abhängigkeit der größten gemeinsamen Schnittmenge an gemessenen Parametern
```{r}
#Auswahl für Globalstrahlung unter var = "solar":
meta1 %>% filter(var == "solar") %>% 
    group_by(res, per) %>%
    summarise(n=n(), .groups = "drop")

# 10_minutes-Resolution: 325 Stationen 
# hourly:47 Stationen
# daily46 Stationen
# per = "recent" hat nur 10-minute resolution!! 
# --> Diese 325 Stationen als Auswahl nehmen und selber Tages-Summen berechnen
```
## Auswahl für Klimadaten unter var = "kl":
```{r}
meta1 %>% filter(var == "kl") %>% 
    group_by(res, per) %>%
    summarise(n=n(), .groups = "drop")
# daily resolution hat die meisten Einträge (#1346) 
```
## Auswahl für rel. Luftfeuchte unter var = "moisture": (für min und max-Berechnung)
```{r}
meta1 %>% filter(var == "moisture") %>% 
    group_by(res, per) %>%
    summarise(n=n(), .groups = "drop")
# subdaily resolution (#1186) hat die meisten Einträge
# hourly hat #712 einträge
```
## Auswahl für Windgeschwindigkeit unter var = "wind": (für min und max-Berechnung)
```{r}
meta1 %>% filter(var == "wind") %>% 
    group_by(res, per) %>%
    summarise(n=n(), .groups = "drop")
# subdaily resolution (#1156) hat die meisten Einträge
# hourly hat #525 einträge
```
## #Funktion zum auslesen der passenden Stations-IDs (für "recent" und "historical")
```{r}
pull_station_id <- function(.var, .res){
    meta1 %>% 
        select(Stations_id, res, var, per) %>%
        filter(var == .var & res == .res) %>% 
        group_by(Stations_id, per) %>% 
        summarise(n =n(), .groups = "drop") %>%
        pivot_wider(id_cols = Stations_id, names_from = per, values_from = n) %>% 
        filter(if_any(c("recent", "historical"), ~!is.na(.))) %>% 
        pull(Stations_id) %>% unique
}
```

```{r}
# Stations-ID für Parameters auslesen
id_globalstrahlung <- pull_station_id(.var = "solar", .res = "10_minutes") 
id_klima <- pull_station_id(.var = "kl", .res = "daily") 
id_moisture <- pull_station_id(.var = "moisture", .res = "subdaily") 
id_wind <- pull_station_id(.var = "wind", .res = "subdaily") 
```

```{r}
#Gemeinsame Schnittmenge der IDs filtern:
id_complete <- data.frame(id = c(id_globalstrahlung, id_klima, id_moisture, id_wind)) %>%
    group_by(id) %>% summarise(n=n()) %>% 
    filter(n == 4) %>% pull(id)
```
318 Stationen liefern alle Parameter zu heutigen und historischen Werten.

## Verwendbare Wetterstationen plotten (Stations-Auswahl == alle Daten vorhanden)
```{r}
Stations_Auswahl <- meta1 %>% filter(Stations_id %in% id_complete) %>%
    select(Stations_id, Stationsname, geoBreite, geoLaenge) %>%
    filter(!duplicated(.)) %>%
    group_by(Stations_id, Stationsname) %>%
    summarise(across(c("geoBreite", "geoLaenge"), ~mean(.)), .groups = "drop")
```

### Deutschland-Grenzen laden:
```{r}
# #Daten laden:
# germany <- geodata::gadm(country = "Germany", level = 0, path = tempdir(), resolution = 2)
# library(raster)
# #In SpatialPolygonsDataFrame konvertieren
# germany_sp <- as(germany, "Spatial")
# #als Shapefile speichern
# rgdal::writeOGR(obj=germany_sp, dsn = "../data/derived_data/Germany_boundaries", layer = "Germany_shapefile",
#driver="ESRI Shapefile") # this is in equal area projection
# #Alle germany-Versionen aus Workspace entfernen
# #rm(list = ls()[grepl(x = ls(), pattern = "germany")])
# detach("package:raster", unload = TRUE)

#Gespeichertes shapefile einlesen:
germany_sp <- rgdal::readOGR(dsn = "../data/derived_data/Germany_boundaries", layer = "Germany_shapefile")
```

```{r, message=FALSE}
ggplot() +
    geom_polygon(data = germany_sp,
                 aes(x = long, y = lat, group = group),
                 colour = "grey10", fill = "#fff7bc") +
    geom_point(data = Stations_Auswahl,
               aes(x = geoLaenge, y = geoBreite),
               alpha = .5, size = 1.5) +
    coord_map() +
    theme_bw() +
    xlab("Longitude") + ylab("Latitude") +
    labs(title = "DWD Weather Stations", subtitle = "inlcuding all parameters")
```






# Daten der Stationsauswahl laden:

## Wetterdaten (unter Ordner "kl" = Klima) 
Hier überspringen. Bereits einmal ausgeführt und Daten gespeichert.
```{r eval=FALSE, include=TRUE}
#Select data from the DWD CDC FTP Server
link <- selectDWD(id = Stations_Auswahl$Stations_id, 
                  res="daily", var="kl", per="", current=FALSE, meta = FALSE)
#per = "": beides
link
#var="kl" = Klima-Daten (alle gemessenen Parameter)

#Download data from the DWD CDC FTP Server --> 150 MB. uncomment to load!
# file <- dataDWD(url = link, read=FALSE, 
# dir = "../data/raw_data/DWDdata/kl_Klima", 
# quiet=TRUE, force=NA)

#if file couldn't be downloaded, remove from list
file <- file[file.exists(file)]
#file <- list.files(path = "../data/raw_data/DWDdata/", full.names = TRUE, pattern = ".zip")

#Process data from the DWD CDC FTP Server to a data.frame
clim <- readDWD(file, varnames=TRUE,fread=TRUE) 
#fread = FALSE for full Windows compatibility
#str(clim)
```

#passende Parameter auswählen:
```{r, eval=FALSE}
clim_filtered <- purrr::map(clim, 
                            ~dplyr::select(.data = .,
                                           # nFK_0010,                         # Alle nFK aus nFK-Tabelle
                                           # nFK_1020, 
                                           # nFK_2030, 
                                           # nFK_3040, 
                                           # nFK_4050, 
                                           # nFK_5060, 
                                           # nFK_0010_Vortag,
                                           # nFK_1020_Vortag,
                                           # nFK_2030_Vortag,
                                           # nFK_3040_Vortag,
                                           # nFK_4050_Vortag,
                                           # nFK_5060_Vortag,
                                           # tage_seit_aussaat,                # Mittelwert für Gras?
                                           Tmean_gradC = TMK.Lufttemperatur,
                                           # Tmean_th9_25_gradC,               #berechnen
                                           Tmin_gradC = TNK.Lufttemperatur_Min,
                                           Tmax_gradC =TXK.Lufttemperatur_Max,
                                           relLuftfeuchte_mean_prozent = UPM.Relative_Feuchte,
                                           # relLuftfeuchte_min_prozent,       #berechnen
                                           # relLuftfeuchte_max_prozent,       #berechnen
                                           # globalstrahlung_Wh_m2,            #in "solar" Ordner --> Tagessumme berechnen
                                           # windgeschwindigkeit_m_s,          #ueberall NA --> eigener Download s.o.
                                           # tageslicht_h,                     #berechnen
                                           # tageslicht_h_th9,                 #berechnen
                                           # Tmean_gradC_sum,                  #berechnen
                                           # Tmean_th9_25_gradC_sum,           #berechnen
                                           # globalstrahlung_Wh_m2_sum,        #berechnen
                                           niederschlag_mm_sum = RSK.Niederschlagshoehe, ##herausnehmen für ANNI?? 
                                           wasser_input_mm = RSK.Niederschlagshoehe#, ##stattdessen Parameter hinzugefügt für ANNI?? 
                                           # tageslicht_h_sum,                 #berechnen
                                           # tageslicht_h_th9_sum,             #berechnen
                                           # Ton_prozent,                      #aus nFK-Tabelle
                                           # Schluff_prozent,                  #aus nFK-Tabelle
                                           # Sand_prozent,                     #aus nFK-Tabelle
                                           # C_org_prozent,                    #aus nFK-Tabelle
                                           # ibi,                              #Mittelwert für Gras?
                                           # irmi,                             #Mittelwert für Gras?
                                           # wasser_input_Vortag,              #berechnen
                            ))

rm(clim)
```

Info zum Niederschlag: "Das Zeitintervall der täglichen Niederschlagshöhe ist als 6 Uhr bis 6
Uhr Folgetag definiert." 
(Quellen: https://opendata.dwd.de/climate_environment/CDC/observations_germany/climate/daily/kl/recent/BESCHREIBUNG_obsgermany_climate_daily_kl_recent_de.pdf)

#gefilterte Daten als RDS speichern:
```{r, eval=FALSE}
#Speichern der Wetterdaten als RDS
# map(1:length(clim_filtered),
#     ~saveRDS(object = clim_filtered[[.]],
#         file = paste0("../data/derived_data/DWD_data/kl_Klima/",
#                       names(clim_filtered)[.],
#                       ".rds"))
# )
```



## Globalstrahlunf (unter Ordner "solar") 
Hier überspringen. Bereits einmal ausgeführt und Daten gespeichert.
```{r eval=FALSE, include=TRUE, max.print = 10}
#Select data from the DWD CDC FTP Server
link <- selectDWD(id = Stations_Auswahl$Stations_id[11:319], 
                  res="10_minutes", var="solar", per=c("recent", "historical"), current=FALSE, meta = FALSE)
link

#Download data from the DWD CDC FTP Server uncomment to load!
# file <- dataDWD(url = link, read=FALSE,
#                 dir = "../data/raw_data/DWDdata/solar_Globalstrahlung/",
#                 quiet=TRUE, force=NA)

#if file couldn't be downloaded, remove from list
file <- file[file.exists(file)]
#file <- list.files(path = "../data/raw_data/DWDdata/solar_Globalstrahlung", full.names = TRUE, pattern = ".zip")
```


```{r eval=FALSE, include=TRUE}
#Process data from the DWD CDC FTP Server to a data.frame
solar <- readDWD(file[1:5], varnames=TRUE,fread=F) 
str(solar)
```

```{r}
df %>% dplyr::select(M)
```

GS_10.Strahlung_Global

```{r}
map_df(solar[1:5], ~.[,"GS_10.Strahlung_Global"] %>% 
        ifelse(.==-999,NA,.) %>%
        range(., na.rm = TRUE)%>% as.matrix %>% t %>% as.data.frame
)

```



























#Bodenfeuchte-Daten laden:
Übersichtskarte der Stationen: https://opendata.dwd.de/climate_environment/CDC/help/stations_map_soil.png

"historical": Tägliche Werte sei 1991-01-01 bis Ende letztes Jahr
"recent": Tägliche Werte dieses Jahres
```{r}
soil_link <- selectDWD(id = 2597, res="", var="", per="", base=dbase, findex=soilIndex)

# download Daten
soil_data <- dataDWD(soil_link, base=dbase, dir=locdir())
```

#Alle Werte in eine lange Tabelle:
```{r}
df_final <- bind_rows(soil_data)
```


#Plot der Bodentemp für 2022
```{r}
#Daten umformen (in lange Tabelle)
clim_melted <- tidyr::pivot_longer(df_final %>%
                                       select(Datum,
                                              BF10, BF20, BF30, BF40, BF50, BF60) %>%
                                       filter(Datum > "2021-12-31"),
                                   cols = BF10:BF60,
                                   names_to = "Variable",
                                   values_to = "value") %>%
    mutate(Tiefe = substring(Variable, 3, nchar(Variable))) %>%
    mutate_at("Tiefe",
              ~as.numeric(.)) %>%
    mutate_at("Variable",
              ~factor(., levels = c("BF10", "BF20", "BF30", "BF40", "BF50", "BF60")))


#Plot:
ggplot(clim_melted, aes(Datum, value, col=as.factor(Tiefe))) +
    geom_rect(aes(xmin = as_date(-Inf), xmax = as_date(Inf),
                  ymin = 60, ymax = 90, fill = "Ausreichend"), color = NA)+
    geom_rect(aes(xmin = as_date(-Inf), xmax = as_date(Inf),
                  ymin = 0, ymax = 60, fill = "Unterversorgt"), color = NA)+
    geom_line()+
    ylab("Nutzbare Feldkapazität (%)") +
    theme_bw() +
    theme(panel.grid = element_blank()) +
    scale_fill_manual("Wasser-\nVersorgunszustand",
                      values = c("Ausreichend"="gray90", "Unterversorgt"="gray80"))

```
#Daten als CSV speichern:
```{r}
#fwrite(x = df_final, "Bodentemp_feuchte_Schifferstadt_1991_2022.csv", sep = ";")
```







---
title: "3. Tabelle erstellen für einen gewählten Satz Spinat --> STÜNDLICHE WERTE"
author: "Samantha Rubo"
date: '2023-06-01'
---

```{r message=FALSE, warning=FALSE, include=FALSE}
library(data.table)
library(dplyr)
library(purrr)
library(ggplot2)
library(lubridate)
library(ggnewscale)
library(tidyr)
library(DBI)
```

#Wetter-Daten aus DB auslesen:
```{r}
path0 <- "GeoSenSys2020/Data_2020/Database_Protokolle/Database_CSV_Tabellen_HGU/HGU_GeoSenSys_V3_6.db"
# Verbindung zur Datenbanl herstellen:
path1 <- ifelse(Sys.info()["user"] == "samantha_machgu",
                "~/Documents/Mac_Github/", 
                "../../"
)
db <- paste0(path1, path0) # DB in other R-Project

db1 <- dbConnect(RSQLite::SQLite(), db)

query2 <- "SELECT *  FROM Wetter_stuendlich;"
wetter <- dbGetQuery(db1, query2) %>% 
    mutate_at("zeit_wetter", ~as_datetime(.))

dbDisconnect(db1)
rm(query2)
names(wetter)

# als csv speichern:
fwrite(x = wetter, file = "../data/derived_data/wetter_stuendlich_2020_2022_20230601.csv", sep = ";")
```

#Tensio einlesen:
```{r}
# #tensio <- fread("../data/derived_data/nfK_2020_2022_20220805_10cm_Schritte.csv") %>%
# #    mutate_at("zeit_messung", ~as_date(.))
# tensio <- fread("../data/derived_data/nfK_2020_2022_20220805.csv") %>%
#     mutate_at("zeit_messung", ~as_date(.))
db1 <- dbConnect(RSQLite::SQLite(), db)
query <- "SELECT 
Spinat_saetze.satz_id,
Parzellen.parzelle_name,
zeit_messung, 
B0020_nFK_prozent, 
B2040_nFK_prozent, 
B4060_nFK_prozent 
FROM Tensiometer
LEFT JOIN Parzellen ON Tensiometer.parzelle_id = Parzellen.parzelle_id
LEFT JOIN Varianten ON Parzellen.variante_id = Varianten.variante_id
LEFT JOIN Spinat_saetze ON Varianten.satz_id = Spinat_saetze.satz_id
"

tensio <- dbGetQuery(db1, query) %>% 
    mutate_at("zeit_messung", ~as_datetime(.))

dbDisconnect(db1)
```

```{r}
tensio <- tensio %>%
    #Auf Stunde abrunden:
    mutate_at("zeit_messung", ~lubridate::floor_date(x = ., unit = "hour"))
```

```{r}
#library(readxl)
bew <- fread("~/Downloads/AW__Gießwagen__genaue_Ausbringzeiten_ablesen_/Wassermengen 2020_Spinat.csv")
bew2 <- bew %>%
    mutate_at("Datum", ~as_date(., format = "%d.%m.%y")) %>%
    mutate(across(c("Startzeit", "Stopzeit"), ~hms::as.hms(.))) %>%
    
    mutate(across(c("Startzeit", "Stopzeit"), ~as_datetime(paste0(Datum, .)), 
                  .names = "{.col}_datetime"), .after = "Stopzeit") %>%
    mutate_at("Stopzeit_datetime", ~ifelse(Stopzeit<Startzeit, 
                                           . + (24*60*60) , #Falls Ende in den frühen Morgenstunden ist: +1 Tag
                                           .) %>% as_datetime) %>%
    mutate(across(ends_with("datetime"), ~.+lubridate::hours(1))) %>%
    mutate(Dauer_h = as.numeric(Stopzeit_datetime - Startzeit_datetime)/(60*60), .after = "Stopzeit")

ggplot(bew2, aes(Datum, Dauer_h)) + geom_point()
hist(bew2$Dauer_h, breaks = seq(0,ceiling(max(bew2$Dauer_h)+1),by = 2))
```


```{r}
df <- tensio %>% mutate(datum_messung = as_date(zeit_messung)) %>% 
    filter(satz_id == 2, datum_messung > "2020-07-27" & parzelle_name == "1a")
df_bew <- bew2 %>% filter(Datum > "2020-07-27" ) %>% 
    select(Datum, Startzeit_datetime, Stopzeit_datetime, Dauer_h, starts_with("F4a")) %>%
    pivot_longer(cols = starts_with("F4a")) %>% 
    group_by(Datum, Startzeit_datetime, Stopzeit_datetime, Dauer_h) %>% 
    summarise(bew_mm = mean(value, na.rm = T), .groups = "drop") %>%
    filter(bew_mm > 0)
```


```{r}
bew_zeit_stuendlich <- map_df(1:nrow(df_bew), 
                              ~data.frame(zeit_bewaesserung = seq.POSIXt(
                                  from = floor_date(df_bew$Startzeit_datetime[.x], unit = "hour"), 
                                  to = ceiling_date(df_bew$Stopzeit_datetime[.x], unit = "hour"), 
                                  by = "1 hour")) %>%
                                  #Anteil der Bewässerungsmenge 
                                  mutate(anteil = c(as.numeric(df_bew$Startzeit_datetime[.x] - zeit_bewaesserung[1]),
                                                    rep(60, times = (n()-2)),
                                                    60  - as.numeric(zeit_bewaesserung[n()] - df_bew$Stopzeit_datetime[.x]))
                                  ) %>%
                                  mutate_at("anteil", ~ifelse(.==0, 60,.)) %>%
                                  mutate(bew_mm = df_bew$bew_mm[.x] / sum(anteil) * anteil), .id = "Bewaesserungs_ereignis"
)
bew_zeit_stuendlich 
```
```{r}
windows1 <- bew_zeit_stuendlich %>% group_by(Bewaesserungs_ereignis) %>%
    summarise(across("zeit_bewaesserung", .fns = list(min, max))) %>% 
    arrange(Bewaesserungs_ereignis)
```

## Beispielplot eines Satzes (satz_id = 2) #












```{r, warning=FALSE}
width1 <- 60*20
ymin1 <- 50
ymax1 <- 140
multi1 <- 30

ggplot() + 
    # geom_rect(data = windows1, aes(xmin = zeit_bewaesserung_1-width1, 
    #                                xmax = zeit_bewaesserung_2+width1, 
    #                                ymin = -Inf, ymax = Inf), fill = "grey90") + 
    geom_rect(data = bew_zeit_stuendlich,
              aes(xmin = zeit_bewaesserung - width1, xmax = zeit_bewaesserung + width1,
                  ymin = ymin1, ymax = ymin1 + bew_mm*multi1), fill = "lightblue") +
    wetter %>% filter(satz_id == 2) %>% select(zeit_wetter, niederschlag_mm) %>% filter(niederschlag_mm != 0)
    
    geom_line(data = df,
              aes(x=zeit_messung, y=B0020_nFK_prozent)) + 
    theme_bw() + 
    theme(panel.grid = element_blank()) + 
    scale_y_continuous(limits = c(ymin1,ymax1), 
                       sec.axis = sec_axis(trans = ~(.-ymin1)/multi1, name = "Bewässerung (mm)")) #+ 
    # scale_x_datetime(limits = c(as_datetime("2020-07-30 00:00:00 UTC"),
    #                             as_datetime("2020-08-02 00:00:00 UTC"))) #+ 
#coord_cartesian()
```


#bewaesserung einlesen: ##Neu: Stündliche Giesswagen-Daten:
```{r}
# bewaesserung <- fread("../data/derived_data/bewaesserung_2020_2022_20220805.csv") %>%
#     mutate_at("datum_bewaesserung", ~as_date(.)) %>%
#     as_tibble()
```

#Alle Tabellen joinen:
```{r}
# input_tabelle <- tensio %>% 
#     left_join(bewaesserung, by = c("satz_id", "variante_H2O", "wiederholung",
#                                    "zeit_messung" = "datum_bewaesserung")) %>%
#     left_join(wetter, by = c("satz_id","zeit_messung" = "datum_wetter")) %>%
#     mutate_at("bewaesserung_mm", ~ifelse(is.na(.), 0, .))
```


### Wasserhaltevermögen der Felder der HGU:
|Schicht Nr.|Bezeichnung|100%nFK entsprechen|"Wassergehalt (Vol.% bei 100%nFK)"|
|:---------:|:---------:|:-----------------:|:--------------------------------:|
|   1       |	0-30 cm	|       49.3 mm     |	            16.4%              |
|   2       |  30-60 cm |       46.1 mm     |	            15.4%              |
|   3       |  60-90 cm |       43.4 mm     |               14.5%              |


\
#Fehlende Werte approximieren:
```{r}
input_tabelle <- input_tabelle %>%
    group_by(satz_id, variante_H2O, wiederholung) %>%
    #Fehlende Werte Approximieren:
    mutate(across(.cols = contains("nFK"), 
                  ~zoo::na.approx(., na.rm = FALSE)))
```

\

## Bodenart anfuegen
```{r}
input_tabelle <- input_tabelle %>% 
    mutate(Ton_prozent = 20,
           Schluff_prozent = 30,
           Sand_prozent = 50,
           C_org_prozent = 1.2)
```

## ISARIA-Daten anfügen
```{r}
db1 <- dbConnect(RSQLite::SQLite(), db)
isaria <- dbGetQuery(db1, "SELECT
                     Spinat_Saetze.satz_id,
                     ISARIA_N.datum_messung,
                     Varianten.variante_H2O,
                     Parzellen.wiederholung,
                     ISARIA_N.ibi,
                     ISARIA_N.irmi
                     FROM ISARIA_N

                     LEFT JOIN Parzellen ON ISARIA_N.parzelle_id = Parzellen.parzelle_id
                     LEFT JOIN Varianten ON Parzellen.variante_id = Varianten.variante_id
                     LEFT JOIN Spinat_Saetze ON Varianten.satz_id = Spinat_Saetze.satz_id;") %>%
    mutate_at("datum_messung", ~as_date(.))
dbDisconnect(db1)

#Mittelwert pro Parzelle Messzeitpunkt
isaria <- isaria %>%
    group_by(satz_id, variante_H2O, wiederholung, datum_messung) %>%
    summarise(across(ibi:irmi, ~mean(., na.rm=TRUE)), .groups = "drop") %>%
    mutate_if(is.numeric, ~round(., 2))


#NEU: smoothed data aus Auswertung verwenden!
# isaria <- fread("../../GeoSenSys2020/Auswertung_Saetze/ISARIA_Alignment/HGU_ISARIA_extrapolated_smoothed.csv") %>%
#      mutate_at("datum_messung", ~as_date(.))
```

#Isaria: Interpolation zwischen den Messtagen:
```{r}
input_tabelle <- input_tabelle %>% 
    left_join(isaria, by = c("satz_id", "variante_H2O", "wiederholung", "zeit_messung" = "datum_messung")) %>% 
    group_by(satz_id, variante_H2O, wiederholung) %>%
    #Werte vor der ersten ISARIA-Messung werden gelöscht (keine Interpolation möglich)
    mutate(delete_leading_NA = ifelse(is.na(ibi), 0, 1) %>% cumsum(.) %>% cumsum(.)) %>%
    filter(delete_leading_NA > 0) %>%
    select(-delete_leading_NA) %>%
    filter(satz_id > 2) %>%
    group_by(satz_id, variante_H2O, wiederholung) %>%
    mutate(across(ibi:irmi,~approx(x=., method = "linear", rule = 1, n = n())$y)) %>%
    ungroup

# ggplot(input_plus_isaria, aes(tage_seit_aussaat, ibi, 
#                               col = as.factor(satz_id), linetype = variante_H2O)) +
# stat_summary(fun = "mean", geom = "line")
```
\


### nFK vom Vortag als Input ausweisen:
```{r}
input_tabelle <- 
    input_tabelle  %>%
    # mutate(across(c("nFK_0010","nFK_1020","nFK_2030","nFK_3040","nFK_4050","nFK_5060"), 
    #               ~c(NA,.[1:(n()-1)]) , 
    #               .names = "{.col}_Vortag")
    # )
    mutate(across(c("T0020_nFK", "T2040_nFK", "T4060_nFK"), 
                  ~c(NA,.[1:(n()-1)]) , 
                  .names = "{.col}_Vortag")
    )
```
\
### Wassereintrag aus P + Bewässerung berechnen. 
```{r}
input_tabelle <- input_tabelle %>% 
    rowwise() %>%
    mutate(wasser_input = sum(niederschlag_mm, bewaesserung_mm, na.rm = TRUE)) %>%
    ungroup %>%
    mutate(wasser_input_Vortag = c(NA,wasser_input[1:(n()-1)]))
```

#Benötigte Variablen selektieren.
```{r}
input_tabelle <- 
    input_tabelle  %>%
    select(-niederschlag_mm, -bewaesserung_mm, -wasser_input,-wiederholung, -satz_id, 
           -variante_H2O, -zeit_messung, -wetter_id, -FAO56_mm, -FAO56_mm_sum, -par_Wh_m2) %>%
    #par_Wh_m2 raus, da bei vielen Stationen nicht enthalten
    select(contains("nFK"), !contains("nFK")) %>%
    tidyr::drop_na()
```

### Tabelle speichern on Projekt-Ordner für Daten
```{r}
# write.table(x = input_tabelle,
#             file = "../data/derived_data/input_tabelle_2020_2022_20230524_25cm_complete.csv",
#             sep = ";",dec = ".", row.names = FALSE)
```


